var DM={version:{major:0,minor:1,build:1,toString:function(){return[this.major,this.minor,this.build].join(".")}},merge:function(B,A){for(prop in B){if(B.hasOwnProperty(prop)){A[prop]=B[prop]}}return A}};DM.ConnectionFactory={connectionPool:{},getConnection:function(B){if(B.name in this.connectionPool){return this.connectionPool[B.name]}var A=false;if(typeof openDatabase!="undefined"){A=new DM.WhatHgConnection(B)}else{if(typeof GearsFactory!="undefined"){A=new DM.GearsConnection(B)}else{if(window.runtime&&typeof window.runtime.flash.data.SQLConnection!="undefined"){A=new DM.AirConnection(B)}}}if(A){this.connectionPool[B.name]=A;return A}else{this.connectionPool[B.name]=null;throw"Unable to find a supported database!"}}};DM.GearsConnection=new Class({initialize:function(A){this.type="gears";this.connInfo=A;if(!DM.GearsConnection.gearFactory){(function(){if(typeof GearsFactory!="undefined"){DM.GearsConnection.gearFactory=new GearsFactory()}else{try{DM.GearsConnection.gearFactory=new ActiveXObject("Gears.Factory");if(DM.GearsConnection.gearFactory.getBuildInfo().indexOf("ie_mobile")!=-1){DM.GearsConnection.gearFactory.privateSetGlobalObject(this)}}catch(B){if((typeof navigator.mimeTypes!="undefined")&&navigator.mimeTypes["application/x-googlegears"]){DM.GearsConnection.gearFactory=document.createElement("object");DM.GearsConnection.gearFactory.style.display="none";DM.GearsConnection.gearFactory.width=0;DM.GearsConnection.gearFactory.height=0;DM.GearsConnection.gearFactory.type="application/x-googlegears";document.documentElement.appendChild(DM.GearsConnection.gearFactory)}}}if(!DM.GearsConnection.gearFactory){throw"There was an error creating the GearsFactory!"}})()}this.connection=DM.GearsConnection.gearFactory.create("beta.database");this.connection.open(A.name)},execute:function(H,B,F,J){var D=this.connection.execute(H,$splat(B).flatten()),A=this.connection.lastInsertRowId,I=[];(I.constructor.prototype||I.prototype).item=function(K){return this[K]};if(D){var E=[];for(var C=0;C<D.fieldCount();C++){E.push(D.fieldName(C))}while(D.isValidRow()){var G={};for(var C=0;C<E.length;C++){G[E[C]]=D.field(C)}I.push(G);D.next()}D.close()}F({insertId:A,rowsAffected:0,rows:I})}});DM.AirConnection=new Class({initialize:function(A){this.type="air";this.connInfo=A;this.connection=new air.SQLConnection();this._dbFile=air.File.applicationStorageDirectory.resolvePath(A.name);this.connection.openAsync(this._dbFile)},execute:function(E,D,F,A){var C=new air.SQLStatement(),B=0;C.sqlConnection=this.connection;C.text=E.replace(/(\?)/g,function(G){return":"+B++});$each(D,function(H,G){C.parameters[":"+G]=H});C.addEventListener(air.SQLEvent.RESULT,function(){F(C.getResult(),event)});C.addEventListener(air.SQLErrorEvent.ERROR,function(){});C.execute()}});DM.WhatHgConnection=new Class({initialize:function(A){this.connInfo=A;this.type="html5";this.connection=openDatabase(A.name,A.description,A.displayName||A.name,A.size)},execute:function(C,B,D,A){this.connection.transaction(function(E){E.executeSql(C,$splat(B).flatten(),function(G,F){D(F)},function(F){})})}});DM.Database=new Class({Implements:[Options,Events],options:{name:"",description:"",displayName:false,size:10240,preferGears:false},initialize:function(A){this.setOptions(A);this.conn=DM.ConnectionFactory.getConnection(this.options);DM.Model.DB=this},execute:function(){var B=$A(arguments).link({sql:String.type,callback:Function.type,params:Array.type,options:Object.type});if(!B.sql){throw"You must provide SQL to execute"}var D=B.sql,E=B.callback?B.callback:function(){},C=B.params||[],A=B.options||{};this.conn.execute(D,C,function(F){E(F)},A)}});DM.Dataset=new Class({});DM.Schema={};DM.Schema.Text=new Class({initialize:function(A,B){B=B||{};this.name=A;this.type="text";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Integer=new Class({initialize:function(A,B){B=B||{};this.name=A;this.type="integer";this.defaultValue=(B.primaryKey)?undefined:B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}if(B.primaryKey){this.type=" INTEGER PRIMARY KEY AUTOINCREMENT"}}});DM.Schema.Float=new Class({initialize:function(A,B){B=B||{};this.name=A;this.type="real";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Blob=new Class({initialize:function(A,B){B=B||{};this.name=A;this.type="blob";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Timestamp=new Class({initialize:function(A,B){B=B||{};this.name=A;this.type="timestamp";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.DSL=new Class({initialize:function(A){this.model=A;this.fields=[];this.dateFields=[];this.columns={};this.eventHandlers={beforeSave:$A([]),afterSave:$A([]),beforeCreate:$A([]),afterCreate:$A([])}},id:function(A,D){var C=A||"id",B=new DM.Schema.Integer(C,{primaryKey:true});this.fields.push(B);this.columns[C]=B;return this},text:function(A,C){var B=new DM.Schema.Text(A,C);this.fields.push(B);this.columns[A]=B;return this},blob:function(A,C){var B=new DM.Schema.Blob(A,C);this.fields.push(B);this.columns[A]=B;return this},timestamp:function(A,B){var C=new DM.Schema.Timestamp(A,B);this.fields.push(C);this.dateFields.push(C);this.columns[A]=C;return this},integer:function(A,C){var B=new DM.Schema.Integer(A,C);this.fields.push(B);this.columns[A]=B;return this},"float":function(A,C){var B=new DM.Schema.Float(A,C);this.fields.push(B);this.columns[A]=B;return this},timestamps:function(A){A=A||"on";this.timestamp("created_"+A,{defaultValue:"NOW"});this.timestamp("updated_"+A,{defaultValue:"NOW"});return this},foreignKey:function(A,B){},hasMany:function(A,B){},hasOne:function(A,B){},belongsTo:function(A,B){},hasAndBelongsToMany:function(A,B){},beforeSave:function(A){this.eventHandlers.beforeSave.push(A)},afterSave:function(A){this.eventHandlers.afterSave.push(A)},beforeCreate:function(A){this.eventHandlers.beforeCreate.push(A)},afterCreate:function(A){this.eventHandlers.afterCreate.push(A)}});DM.SQL=(function(){function A(){return $A(arguments).join(" ")}function B(C){return C.fields.filter(function(D){return(D.name!="id")})}return{createForModel:function(C){var D=A("CREATE TABLE","IF NOT EXISTS",C.table_name,"(",C.fields.map(function(E){return A(E.name,E.type)}).join(", "),");");return D},updateForModel:function(D){var C=[],E=A("UPDATE",D.table_name,"SET",B(D).map(function(F){C.push(D.get(F.name,true));return A(F.name,"=","?")}).join(", "),"WHERE id = ?;");C.push(D.id);return[E,C]},insertForModel:function(D){var C=[],E=A("INSERT INTO",D.table_name,"(",B(D).map(function(F){C.push(D.get(F.name,true));return F.name}).join(", "),") VALUES (",B(D).map(function(F){return"?"}).join(", "),");");return[E,C]},deleteForModel:function(C){var D=A("DELETE FROM",C.table_name,"WHERE id = ?;");return[D,[C.id]]}}})();DM.ModelInstance=new Class({initialize:function(B,A){this.table_name=A.table_name;this.fields=A.fields;this.columns=A.columns;this.klass=A;this.isDirty=false;this.attributes=$H(B);this.id=B.id||null},get:function(B,A){if(B in this.columns){if(this.columns[B].type=="timestamp"){return(A)?this.attributes[B]:new Date(this.attributes[B])}else{return this.attributes[B]}}else{throw ("'"+B+"' is not a valid column for table "+this.table_name)}},set:function(A,B){if(A in this.columns){if(this.columns[A].type=="timestamp"){switch($type(B)){case"date":B=B.getTime();break;case"string":B=Date.parse(B);break;case"number":B=B;break;default:B=B}}if(B!=this.attributes[A]){this.isDirty=true;this.attributes[A]=B}}else{throw ("'"+A+"' is not a valid column for table "+this.table_name)}return this},update:function(B,C){var A=this;$H(B).forEach(function(F,E){if(F!=A.get(E)){try{A.set(E,F);A.isDirty=true}catch(D){if(!C){throw D}}}})},save:function(C){var B=this,C=C||function(){};if("updated_on" in this.columns){this.set("updated_on",new Date())}if("updated_at" in this.columns){this.set("updated_at",new Date())}if($type(B.id)=="number"){B.klass._handleEvent("beforeSave",this);var A=DM.SQL.updateForModel(this);DM.Model.DB.execute(A[0],A[1],function(D){B.klass._handleEvent("afterSave",B);C(B)})}else{if("created_on" in this.columns){this.set("created_on",new Date())}if("created_at" in this.columns){this.set("created_at",new Date())}B.klass._handleEvent("beforeCreate",B);B.klass._handleEvent("beforeSave",B);var A=DM.SQL.insertForModel(this);DM.Model.DB.execute(A[0],A[1],function(D){B.id=D.insertId;B.attributes.id=B.id;B.klass._handleEvent("afterSave",B);B.klass._handleEvent("afterCreate",B);C(B)})}},reload:function(A){if($type(this.id)=="number"){}},destroy:function(C){if($type(this.id)=="number"){var B=this,A=DM.SQL.deleteForModel(this),C=C||function(){};DM.Model.DB.execute(A[0],A[1],function(D){B.id=null;B.set("id",null);C(B)})}},toString:function(){return"[#Model:"+this.table_name+' id="'+this.id+'"]'}});DM.Model=(function(){return new Class({initialize:function(A,C){if(!C){throw"Model definitions missing!"}this.table_name=A;if(C.schema){var B=new DM.Schema.DSL(this).id();C.schema(B);this.fields=B.fields;this.columns=B.columns;this.eventHandlers=B.eventHandlers;delete C.schema}else{this.fields=[];this.columns=[];this.eventHandlers={}}DM.Model.knownModels[A]=this},find:function(C,B){var A=this;DM.Model.DB.execute("select * from "+this.table_name+" where id = "+C+";",function(E){if(E.rows.length>0){var D=new DM.ModelInstance(E.rows.item(0),A);B(D)}else{throw ("find( "+C+" ) returned 0 results.")}})},all:function(B){var A=this;DM.Model.DB.execute("select * from "+this.table_name+";",function(D){var F=[];for(var C=0;C<D.rows.length;C++){var E=D.rows.item(C);F.push(new DM.ModelInstance(E,A))}B(F)})},count:function(C){var A=this,B=0;DM.Model.DB.execute("select count(id) as cnt from "+this.table_name+";",function(D){B=D.rows.item(0)["cnt"];C(B)})},destroyAll:function(B){var A=this,B=B||function(){};A.all(function(E){var C=E.length,D=1;E.each(function(F){F.destroy(function(){D++;if(D==C){B(E)}})})})},create:function(A){return new DM.ModelInstance((A||{}),this)},_handleEvent:function(A,B){if(A in this.eventHandlers){this.eventHandlers[A].each(function(C){C(B)})}}})})();DM.Model.knownModels=$H({});DM.Model.createModels=function(){if(DM.Model.DB){DM.Model.knownModels.each(function(A,B){DM.Model.DB.execute(DM.SQL.createForModel(A),function(){A.tableCreated=true})})}else{}};