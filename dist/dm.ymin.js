var DM={AUTHOR:"M@ McCray <darthapo@gmail.com>",VERSION:"0.1.2",};var Options={setOptions:function(C){var A=$H(this.options||{}),B=$H(C||{});this.options=A.merge(B).toObject()}};DM.AirConnection=Class.create({initialize:function(A){this.type="air";this.connInfo=A;this.connection=new air.SQLConnection();this._dbFile=air.File.applicationStorageDirectory.resolvePath(A.name);this.connection.openAsync(this._dbFile)},execute:function(E,D,F,A){var C=new air.SQLStatement(),B=0;C.sqlConnection=this.connection;C.text=E.replace(/(\?)/g,function(G){return":"+B++});$H(D).each(function(G){C.parameters[":"+G.key]=G.value});C.addEventListener(air.SQLEvent.RESULT,function(){F(C.getResult(),event)});C.addEventListener(air.SQLErrorEvent.ERROR,function(){});C.execute()}});(function(A){if(!A){return }if(window.air&&air.Introspector){window.console=air.Introspector.Console}else{window.console={log:function(B){A.trace(B)},info:function(B){console.log("INFO: "+B)}}}})(window.runtime);DM.GearsConnection=Class.create({initialize:function(A){this.type="gears";this.connInfo=A;if(!DM.GearsConnection.gearFactory){(function(){if(typeof GearsFactory!="undefined"){DM.GearsConnection.gearFactory=new GearsFactory()}else{try{DM.GearsConnection.gearFactory=new ActiveXObject("Gears.Factory");if(DM.GearsConnection.gearFactory.getBuildInfo().indexOf("ie_mobile")!=-1){DM.GearsConnection.gearFactory.privateSetGlobalObject(this)}}catch(B){if((typeof navigator.mimeTypes!="undefined")&&navigator.mimeTypes["application/x-googlegears"]){DM.GearsConnection.gearFactory=document.createElement("object");DM.GearsConnection.gearFactory.style.display="none";DM.GearsConnection.gearFactory.width=0;DM.GearsConnection.gearFactory.height=0;DM.GearsConnection.gearFactory.type="application/x-googlegears";document.documentElement.appendChild(DM.GearsConnection.gearFactory)}}}if(!DM.GearsConnection.gearFactory){throw"There was an error creating the GearsFactory!"}})()}this.connection=DM.GearsConnection.gearFactory.create("beta.database");this.connection.open(A.name)},execute:function(H,B,F,J){var D=this.connection.execute(H,$A(B).flatten()),A=this.connection.lastInsertRowId,I=[];(I.constructor.prototype||I.prototype).item=function(K){return this[K]};if(D){var E=[];for(var C=0;C<D.fieldCount();C++){E.push(D.fieldName(C))}while(D.isValidRow()){var G={};for(var C=0;C<E.length;C++){G[E[C]]=D.field(C)}I.push(G);D.next()}D.close()}F({insertId:A,rowsAffected:0,rows:I})}});DM.Html5Connection=Class.create({initialize:function(A){this.connInfo=A;this.type="html5";this.connection=openDatabase(A.name,A.description,A.displayName||A.name,A.size)},execute:function(C,B,D,A){this.connection.transaction(function(E){E.executeSql(C,$A(B).flatten(),function(G,F){D(F)},function(F){})})}});DM.ConnectionFactory={connectionPool:$H(),getConnection:function(B){if(this.connectionPool.get(B.name)){return this.connectionPool.get(B.name)}var A=false;if(typeof openDatabase!="undefined"){A=new DM.Html5Connection(B)}else{if(typeof GearsFactory!="undefined"){A=new DM.GearsConnection(B)}else{if(window.runtime&&typeof window.runtime.flash.data.SQLConnection!="undefined"){A=new DM.AirConnection(B)}}}if(A){this.connectionPool.set(B.name,A);return A}else{this.connectionPool.set(B.name,null);throw"Unable to find a supported database!"}}};DM.Database=Class.create(Options,{options:{name:"",description:"",displayName:false,size:10240,preferGears:false},initialize:function(A){this.setOptions(A);this.conn=DM.ConnectionFactory.getConnection(this.options);DM.Model.DB=this},execute:function(C,B,D,A){if(!C){throw"You must provide SQL to execute"}var D=D||function(){},B=B||[],A=A||{};this.conn.execute(C,B,function(E){D(E)},A)}});DM.Dataset=Class.create({initialize:function(A){this.tableName=A;this.conditions=[];this.values=[];this.ordering=[]},filter:function(D,A,E,F){if(arguments.length==2){E=A;var C=D.split(" ");if(C.length<2){throw"Invalid filter syntax"}A=C.pop();D=C.join(" ")}else{if(arguments.length==1){var B=$A(arguments[0]);D=B[0];A=B[1];E=B[2]}}F=F||"AND";this.conditions.push({col:D,com:A,val:"?",cnd:F});this.values.push(E);return this},where:function(B,A,C){return this.filter(B,A,C)},and:function(B,A,C){return this.filter(B,A,C,"AND")},or:function(B,A,C){return this.filter(B,A,C,"OR")},order:function(A,B){B=B||"ASC";this.ordering.push(A+" "+B);return this},each:function(B){var A=this;DM.Model.DB.execute(this.toSql(),this.values,function(D){for(var C=0;C<D.rows.length;C++){var E=D.rows.item(C);B(E,C,D)}});return this},all:function(B){if(B){var A=this;DM.Model.DB.execute(this.toSql(),this.values,function(D){var E=[];for(var C=0;C<D.rows.length;C++){E.push(D.rows.item(C))}B(E)})}else{this.conditions=[];this.values=[];this.ordering=[]}return this},count:function(A){return this},add:function(A,B){return this},update:function(A,B){return this},destroy:function(A,B){return this},clone:function(){var A=new DM.Dataset(this.tableName);A.conditions=$A(this.conditions).clone();A.values=$A(this.values).clone();A.ordering=$A(this.ordering).clone();return A},toSql:function(A){var A=A||"SELECT",B=A+" * FROM "+this.tableName;if(this.conditions.length>0){B+=" WHERE ";$A(this.conditions).each(function(D,C){if(C>0){B+=D.cnd+" "}B+="("+D.col+" "+D.com+" "+D.val+") "})}if(this.ordering.length>0){B+=" ORDER BY "+this.ordering.join(", ")}B+=";";return B},toString:function(){return this.toSql()}});Object.extend(String.prototype,{eq:function(A){return[this,"=",A]},like:function(A){return[this,"like",A]},neq:function(A){return[this,"!=",A]},lt:function(A){return[this,"<",A]},gt:function(A){return[this,">",A]},lteq:function(A){return[this,"<=",A]},gteq:function(A){return[this,">=",A]},});DM.ModelInstance=Class.create({initialize:function(B,A){this.table_name=A.table_name;this.fields=A.fields;this.columns=A.columns;this.klass=A;this.isDirty=false;this.attributes=$H(B||{});this.id=this.attributes.get("id")||null},get:function(B,A){if(B in this.columns){if(this.columns[B].type=="timestamp"){return(A)?this.attributes.get(B):new Date(this.attributes.get(B))}else{return this.attributes.get(B)}}else{throw ("'"+B+"' is not a valid column for table "+this.table_name)}},set:function(A,B){if(A in this.columns){if(this.columns[A].type=="timestamp"){switch(typeof (B)){case"string":B=Date.parse(B);break;case"number":B=B;break;default:B=B.getTime()}}if(B!=this.attributes.get(A)){this.isDirty=true;this.attributes.set(A,B)}}else{throw ("'"+A+"' is not a valid column for table "+this.table_name)}return this},update:function(B,C){var A=this;$H(B).each(function(E){if(E.value!=A.get(E.key)){try{A.set(E.key,E.value);A.isDirty=true}catch(D){if(!C){throw D}}}})},save:function(E){var C=this,E=E||function(){};if("updated_on" in this.columns){this.set("updated_on",new Date())}if("updated_at" in this.columns){this.set("updated_at",new Date())}if(typeof (C.id)=="number"){C.klass._handleEvent("beforeSave",this);var A=DM.SQL.updateForModel(this);DM.Model.DB.execute(A[0],A[1],function(F){C.klass._handleEvent("afterSave",C);E(C)})}else{if("created_on" in this.columns){this.set("created_on",new Date())}if("created_at" in this.columns){this.set("created_at",new Date())}C.klass._handleEvent("beforeCreate",C);C.klass._handleEvent("beforeSave",C);var A=DM.SQL.insertForModel(this),D=A.first(),B=A.last();DM.Model.DB.execute(D,B,function(F){C.id=F.insertId;C.attributes.set("id",C.id);C.klass._handleEvent("afterSave",C);C.klass._handleEvent("afterCreate",C);E(C)})}},reload:function(A){if(typeof (this.id)=="number"){}},destroy:function(C){if(typeof (this.id)=="number"){var B=this,A=DM.SQL.deleteForModel(this),C=C||function(){};DM.Model.DB.execute(A[0],A[1],function(D){B.id=null;B.set("id",null);C(B)})}},toString:function(){return"[#Model:"+this.table_name+' id="'+this.id+'"]'}});DM.Model=(function(){return Class.create({initialize:function(A,C){if(!C){throw"Model definitions missing!"}this.table_name=A;if(C.schema){var B=new DM.Schema.DSL(this).id();C.schema(B);this.fields=B.fields;this.columns=B.columns;this.eventHandlers=B.eventHandlers;delete C.schema}else{this.fields=[];this.columns=[];this.eventHandlers={}}DM.Model.knownModels.set(A,this)},find:function(C,B){var A=this;DM.Model.DB.execute("select * from "+this.table_name+" where id = "+C+";",[],function(E){if(E.rows.length>0){var D=new DM.ModelInstance(E.rows.item(0),A);B(D)}else{throw ("find( "+C+" ) returned 0 results.")}})},all:function(B){var A=this;DM.Model.DB.execute("select * from "+this.table_name+";",[],function(D){var F=[];for(var C=0;C<D.rows.length;C++){var E=D.rows.item(C);F.push(new DM.ModelInstance(E,A))}B(F)})},count:function(C){var A=this,B=0;DM.Model.DB.execute("select count(id) as cnt from "+this.table_name+";",[],function(D){B=D.rows.item(0)["cnt"];C(B)})},destroyAll:function(B){var A=this,B=B||function(){};A.all(function(E){var C=E.length,D=1;E.each(function(F){F.destroy(function(){D++;if(D==C){B(E)}})})})},create:function(A){return new DM.ModelInstance((A||{}),this)},_handleEvent:function(A,B){if(A in this.eventHandlers){this.eventHandlers[A].each(function(C){C(B)})}}})})();DM.Model.knownModels=$H();DM.Model.createModels=function(){if(DM.Model.DB){DM.Model.knownModels.each(function(C){var A=C.value,B=C.key;DM.Model.DB.execute(DM.SQL.createForModel(A),[],function(){A.tableCreated=true})})}else{console.log("DM.Model.createModels: Error: No database is defined.")}};DM.Schema={};DM.Schema.Text=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="text";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Integer=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="integer";this.defaultValue=(B.primaryKey)?undefined:B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}if(B.primaryKey){this.type=" INTEGER PRIMARY KEY AUTOINCREMENT"}}});DM.Schema.Float=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="real";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Blob=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="blob";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Timestamp=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="timestamp";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.DSL=Class.create({initialize:function(A){this.model=A;this.fields=[];this.dateFields=[];this.columns={};this.eventHandlers={beforeSave:$A([]),afterSave:$A([]),beforeCreate:$A([]),afterCreate:$A([])}},id:function(A,D){var C=A||"id",B=new DM.Schema.Integer(C,{primaryKey:true});this.fields.push(B);this.columns[C]=B;return this},text:function(A,C){var B=new DM.Schema.Text(A,C);this.fields.push(B);this.columns[A]=B;return this},blob:function(A,C){var B=new DM.Schema.Blob(A,C);this.fields.push(B);this.columns[A]=B;return this},timestamp:function(A,B){var C=new DM.Schema.Timestamp(A,B);this.fields.push(C);this.dateFields.push(C);this.columns[A]=C;return this},integer:function(A,C){var B=new DM.Schema.Integer(A,C);this.fields.push(B);this.columns[A]=B;return this},"float":function(A,C){var B=new DM.Schema.Float(A,C);this.fields.push(B);this.columns[A]=B;return this},timestamps:function(A){A=A||"on";this.timestamp("created_"+A,{defaultValue:"NOW"});this.timestamp("updated_"+A,{defaultValue:"NOW"});return this},foreignKey:function(A,B){},hasMany:function(A,B){},hasOne:function(A,B){},belongsTo:function(A,B){},hasAndBelongsToMany:function(A,B){},beforeSave:function(A){this.eventHandlers.beforeSave.push(A)},afterSave:function(A){this.eventHandlers.afterSave.push(A)},beforeCreate:function(A){this.eventHandlers.beforeCreate.push(A)},afterCreate:function(A){this.eventHandlers.afterCreate.push(A)}});DM.SQL=(function(){function A(){return $A(arguments).join(" ")}function B(C){return C.fields.filter(function(D){return(D.name!="id")})}return{createForModel:function(C){var D=A("CREATE TABLE","IF NOT EXISTS",C.table_name,"(",C.fields.map(function(E){return A(E.name,E.type)}).join(", "),");");return D},updateForModel:function(D){var C=[],E=A("UPDATE",D.table_name,"SET",B(D).map(function(F){C.push(D.get(F.name,true));return A(F.name,"=","?")}).join(", "),"WHERE id = ?;");C.push(D.id);return[E,C]},insertForModel:function(D){var C=[],E=A("INSERT INTO",D.table_name,"(",B(D).map(function(F){C.push(D.get(F.name,true));return F.name}).join(", "),") VALUES (",B(D).map(function(F){return"?"}).join(", "),");");return[E,C]},deleteForModel:function(C){var D=A("DELETE FROM",C.table_name,"WHERE id = ?;");return[D,[C.id]]}}})();