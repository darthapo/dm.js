var DM={AUTHOR:"M@ McCray <darthapo@gmail.com>",VERSION:"0.1.2",};DM.DB={execute:function(){throw"No DB connection has been made!!!"}};DM.Options={setOptions:function(C){var A=$H(this.options||{}),B=$H(C||{});this.options=A.merge(B).toObject()}};DM.Database=Class.create(DM.Options,{options:{name:"",description:"",displayName:false,size:10240,preferGears:false},initialize:function(A){this.setOptions(A);this.conn=DM.ConnectionFactory.getConnection(this.options);DM.DB=this},execute:function(C,B,D,A){if(!C){throw"You must provide SQL to execute"}var D=D||function(){},B=B||[],A=A||{};this.conn.execute(C,B,function(E){D(E)},A)}});DM.AirConnection=Class.create({initialize:function(A){this.type="air";this.connInfo=A;this.connection=new air.SQLConnection();this._dbFile=air.File.applicationStorageDirectory.resolvePath(A.name);this.connection.openAsync(this._dbFile)},execute:function(E,D,F,A){var C=new air.SQLStatement(),B=0;C.sqlConnection=this.connection;C.text=E.replace(/(\?)/g,function(G){return":"+B++});$H(D).each(function(G){C.parameters[":"+G.key]=G.value});C.addEventListener(air.SQLEvent.RESULT,function(){F(C.getResult(),event)});C.addEventListener(air.SQLErrorEvent.ERROR,function(){});C.execute()}});(function(A){if(!A){return }if(window.air&&air.Introspector){window.console=air.Introspector.Console}else{window.console={log:function(B){A.trace(B)},info:function(B){console.log("INFO: "+B)}}}})(window.runtime);DM.GearsConnection=Class.create({initialize:function(A){this.type="gears";this.connInfo=A;if(!DM.GearsConnection.gearFactory){(function(){if(typeof GearsFactory!="undefined"){DM.GearsConnection.gearFactory=new GearsFactory()}else{try{DM.GearsConnection.gearFactory=new ActiveXObject("Gears.Factory");if(DM.GearsConnection.gearFactory.getBuildInfo().indexOf("ie_mobile")!=-1){DM.GearsConnection.gearFactory.privateSetGlobalObject(this)}}catch(B){if((typeof navigator.mimeTypes!="undefined")&&navigator.mimeTypes["application/x-googlegears"]){DM.GearsConnection.gearFactory=document.createElement("object");DM.GearsConnection.gearFactory.style.display="none";DM.GearsConnection.gearFactory.width=0;DM.GearsConnection.gearFactory.height=0;DM.GearsConnection.gearFactory.type="application/x-googlegears";document.documentElement.appendChild(DM.GearsConnection.gearFactory)}}}if(!DM.GearsConnection.gearFactory){throw"There was an error creating the GearsFactory!"}})()}this.connection=DM.GearsConnection.gearFactory.create("beta.database");this.connection.open(A.name)},execute:function(H,B,F,J){var D=this.connection.execute(H,$A(B).flatten()),A=this.connection.lastInsertRowId,I=[];(I.constructor.prototype||I.prototype).item=function(K){return this[K]};if(D){var E=[];for(var C=0;C<D.fieldCount();C++){E.push(D.fieldName(C))}while(D.isValidRow()){var G={};for(var C=0;C<E.length;C++){G[E[C]]=D.field(C)}I.push(G);D.next()}D.close()}F({insertId:A,rowsAffected:0,rows:I})}});DM.Html5Connection=Class.create({initialize:function(A){this.connInfo=A;this.type="html5";this.connection=openDatabase(A.name,A.description,A.displayName||A.name,A.size)},execute:function(C,B,D,A){this.connection.transaction(function(E){E.executeSql(C,$A(B).flatten(),function(G,F){D(F)},function(F){})})}});DM.ConnectionFactory={connectionPool:$H(),getConnection:function(B){if(this.connectionPool.get(B.name)){return this.connectionPool.get(B.name)}var A=false;if(typeof openDatabase!="undefined"){A=new DM.Html5Connection(B)}else{if(typeof GearsFactory!="undefined"){A=new DM.GearsConnection(B)}else{if(window.runtime&&typeof window.runtime.flash.data.SQLConnection!="undefined"){A=new DM.AirConnection(B)}}}if(A){this.connectionPool.set(B.name,A);return A}else{this.connectionPool.set(B.name,null);throw"Unable to find a supported database!"}}};DM.DeferredCallback=Class.create({initialize:function(B,C,A){this.target=B;this.current=0;this.callback=C;this.args=A},ping:function(){this.current++;if(this.current==this.target){this.callback.apply(null,this.args)}else{console.log("Not yet...")}}});DM.Dataset=Class.create({initialize:function(A,B){this.tableName=A;this.conditions=[];this.values=[];this.ordering=[];this.options=$H({asModel:false}).update(B||{})},filter:function(D,A,E,F){if(arguments.length==2){E=A;var C=D.split(" ");if(C.length<2){throw"Invalid filter syntax"}A=C.pop();D=C.join(" ")}else{if(arguments.length==1){var B=$A(arguments[0]);D=B[0];A=B[1];E=B[2]}}F=F||"AND";this.conditions.push({col:D,com:A,val:"?",cnd:F});this.values.push(E);return this},where:function(B,A,C){return this.filter(B,A,C)},and:function(B,A,C){return this.filter(B,A,C,"AND")},or:function(B,A,C){return this.filter(B,A,C,"OR")},order:function(A,B){B=B||"ASC";this.ordering.push(A+" "+B);return this},each:function(B){var A=this;DM.DB.execute(this.toSql(),this.values,function(D){for(var C=0;C<D.rows.length;C++){var E=A.options.asModel?new DM.ModelInstance(D.rows.item(C),A.options.modelKlass):D.rows.item(C);B(E,C,D)}});return this},all:function(B){if(B){var A=this;DM.DB.execute(this.toSql(),this.values,function(D){var E=[];if(A.options.asModel){for(var C=0;C<D.rows.length;C++){E.push(new DM.ModelInstance(D.rows.item(C),A.options.modelKlass))}}else{for(var C=0;C<D.rows.length;C++){E.push(D.rows.item(C))}}B(E)})}else{this.conditions=[];this.values=[];this.ordering=[]}return this},results:function(A){this.all(A)},add:function(E,G){var C=this,D=G||function(){};if(Object.isArray(E)){console.log("!!! Data is ARRAY!!!");var F=[],B=new DM.DeferredCallback(E.length,G,[F]);$A(E).each(function(I){var H=DM.SQL.insertForObject(I,C.tableName);DM.DB.execute(H[0],H[1],function(J){I.id=J.insertId;F.push(I);B.ping()})})}else{var A=DM.SQL.insertForObject(E,this.tableName);DM.DB.execute(A[0],A[1],function(H){E.id=H.insertId;D(E,H)})}return this},update:function(D,E){var B=this,A=DM.SQL.updateForObject(D,this.tableName),C=E||function(){};DM.DB.execute(A[0],A[1],function(F){C(D,F)});return this},destroy:function(C,D){var B=this,A=DM.SQL.deleteForModel(C,this.tableName);DM.DB.execute(A[0],A[1],function(E){D(C,E)});return this},destroyAll:function(B){var A=this;this.each(function(C){this.destroy(C,B)});return this},clone:function(){var A=new DM.Dataset(this.tableName);A.conditions=$A(this.conditions).clone();A.values=$A(this.values).clone();A.ordering=$A(this.ordering).clone();return A},toSql:function(A){var A=A||"SELECT",B=A+" * FROM "+this.tableName;if(this.conditions.length>0){B+=" WHERE ";$A(this.conditions).each(function(D,C){if(C>0){B+=D.cnd+" "}B+="("+D.col+" "+D.com+" "+D.val+") "})}if(this.ordering.length>0){B+=" ORDER BY "+this.ordering.join(", ")}B+=";";return B},toString:function(){return this.toSql()}});Object.extend(String.prototype,{eq:function(A){return[this,"=",A]},like:function(A){return[this,"like",A]},neq:function(A){return[this,"!=",A]},lt:function(A){return[this,"<",A]},gt:function(A){return[this,">",A]},lteq:function(A){return[this,"<=",A]},gteq:function(A){return[this,">=",A]},});DM.SQL=(function(){function B(){return $A(arguments).join(" ")}function C(D){return D.fields.filter(function(E){return(E.name!="id")})}function A(D){if(D instanceof Date){return D.getTime()}else{return D}}return{createForModel:function(D){var E=B("CREATE TABLE","IF NOT EXISTS",D.table_name,"(",D.fields.map(function(F){return B(F.name,F.type)}).join(", "),");");return E},createForSchema:function(E,D){E.table_name=D;return this.createForModel(E)},updateForModel:function(E){var D=[],F=B("UPDATE",E.table_name,"SET",C(E).map(function(G){D.push(E.get(G.name,true));return B(G.name,"=","?")}).join(", "),"WHERE id = ?;");D.push(E.id);return[F,D]},insertForModel:function(E){var D=[],F=B("INSERT INTO",E.table_name,"(",C(E).map(function(G){D.push(E.get(G.name,true));return G.name}).join(", "),") VALUES (",C(E).map(function(G){return"?"}).join(", "),");");return[F,D]},deleteForModel:function(D){var E=B("DELETE FROM",D.table_name,"WHERE id = ?;");return[E,[D.id]]},updateForObject:function(F,D){if(!F.id){throw"Object must have an ID to be updated..."}var E=[],G=$H(F),H=B("UPDATE",D,"SET",G.keys().without("id").map(function(I){E.push(A(G.get(I)));return B(I,"=","?")}).join(", "),"WHERE id = ?;");E.push(G.get("id"));return[H,E]},insertForObject:function(F,D){var E=[],G=$H(F),H=B("INSERT INTO",D,"(",G.keys().without("id").map(function(I){E.push(A(G.get(I)));return I}).join(", "),") VALUES (",G.keys().without("id").map(function(I){return"?"}).join(", "),");");return[H,E]},deleteForModel:function(E,D){var F=(typeof E=="number")?E:E.id;sql=B("DELETE FROM",D,"WHERE id = ?;");return[sql,[F]]}}})();DM.Schema={};DM.Schema.Text=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="text";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Integer=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="integer";this.defaultValue=(B.primaryKey)?undefined:B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}if(B.primaryKey){this.type=" INTEGER PRIMARY KEY AUTOINCREMENT"}}});DM.Schema.Float=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="real";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Blob=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="blob";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.Timestamp=Class.create({initialize:function(A,B){B=B||{};this.name=A;this.type="timestamp";this.defaultValue=B.defaultValue;this.allowNull=B.allowNull;if(B.notNull){this.allowNull=!B.notNull}}});DM.Schema.DSL=Class.create({initialize:function(A){this.model=A;this.fields=[];this.dateFields=[];this.columns={};this.relationships=[];this.eventHandlers={beforeSave:$A([]),afterSave:$A([]),beforeCreate:$A([]),afterCreate:$A([])}},id:function(A,D){var C=A||"id",B=new DM.Schema.Integer(C,{primaryKey:true});this.fields.push(B);this.columns[C]=B;return this},text:function(A,C){var B=new DM.Schema.Text(A,C);this.fields.push(B);this.columns[A]=B;return this},blob:function(A,C){var B=new DM.Schema.Blob(A,C);this.fields.push(B);this.columns[A]=B;return this},timestamp:function(A,B){var C=new DM.Schema.Timestamp(A,B);this.fields.push(C);this.dateFields.push(C);this.columns[A]=C;return this},integer:function(A,C){var B=new DM.Schema.Integer(A,C);this.fields.push(B);this.columns[A]=B;return this},"float":function(A,C){var B=new DM.Schema.Float(A,C);this.fields.push(B);this.columns[A]=B;return this},timestamps:function(A){A=A||"on";this.timestamp("created_"+A,{defaultValue:"NOW"});this.timestamp("updated_"+A,{defaultValue:"NOW"});return this},hasMany:function(A,B){this.relationships.push(new DM.Relationships.HasMany(A,B,this))},belongsTo:function(A,B){this.integer(A.table_name.singularize()+"_id",{allowNull:false});this.relationships.push(new DM.Relationships.BelongsTo(A,B,this))},beforeSave:function(A){this.eventHandlers.beforeSave.push(A)},afterSave:function(A){this.eventHandlers.afterSave.push(A)},beforeCreate:function(A){this.eventHandlers.beforeCreate.push(A)},afterCreate:function(A){this.eventHandlers.afterCreate.push(A)}});DM.Schema._tables=$H({});DM.Schema.defineTable=function(B,A){var C=new DM.Schema.DSL(B).id();A(C);DM.Schema._tables.set(B,C);return C};DM.Schema.createAllTables=function(){if(DM.DB){DM.Schema._tables.keys().each(function(A){console.log("Creating table: "+A);DM.DB.execute(DM.SQL.createForSchema(DM.Schema._tables.get(A),A),[],function(){console.log("Table created:",A)})})}else{console.log("DM.Schema.createAllTables: Error: No database is defined.")}};